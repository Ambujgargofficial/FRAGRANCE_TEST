import React, { useState } from 'react';
import { 
  Wind, 
  Zap, 
  Brain, 
  Trees, 
  Heart, 
  RefreshCw, 
  ArrowRight, 
  Sparkles,
  CheckCircle,
  Activity
} from 'lucide-react';

// --- DATA MAPPING BASED ON USER SHEET ---
const FRAGRANCE_DB = [
  {
    id: 1,
    name: "Tranquil Sleep",
    primaryNeed: "SI", 
    secondaryNeed: "EI",
    triggers: { SI: 9, EI: 2, FI: 0, EnI: 0, SEI: 5 }, 
    description: "Deep relaxation for poor sleep and high stress.",
    moods: ["Relaxation", "Anxiety Relief", "Insomnia Aid"],
    icon: <Wind className="w-6 h-6" />
  },
  {
    id: 2,
    name: "Morning Vitality",
    primaryNeed: "EI", 
    secondaryNeed: "SI",
    triggers: { SI: 3, EI: 9, FI: 5, EnI: 0, SEI: 0 },
    description: "Gentle awakening for morning fatigue and low energy.",
    moods: ["Gentle Awakening", "Mood Uplift", "Energy Boost"],
    icon: <Zap className="w-6 h-6" />
  },
  {
    id: 3,
    name: "Focus Flow",
    primaryNeed: "FI", 
    secondaryNeed: "SI",
    triggers: { SI: 5, EI: 5, FI: 9, EnI: 0, SEI: 0 },
    description: "Enhances concentration and mental clarity for desk work.",
    moods: ["High Focus", "Mental Clarity", "Concentration"],
    icon: <Brain className="w-6 h-6" />
  },
  {
    id: 4,
    name: "Emotional Balance",
    primaryNeed: "SEI", 
    secondaryNeed: "SI",
    triggers: { SI: 6, EI: 5, FI: 0, EnI: 0, SEI: 9 },
    description: "Grounding and stability for emotional swings.",
    moods: ["Inner Stability", "Grounding", "Calm"],
    icon: <Heart className="w-6 h-6" />
  },
  {
    id: 5,
    name: "Calm Confidence",
    primaryNeed: "SI", 
    secondaryNeed: "FI",
    triggers: { SI: 8, EI: 6, FI: 7, EnI: 0, SEI: 4 },
    description: "Boosts presence and reduces anxiety during high interaction.",
    moods: ["Confidence", "Presence", "Networking"],
    icon: <Sparkles className="w-6 h-6" />
  },
  {
    id: 6,
    name: "Digital Detox",
    primaryNeed: "EnI", 
    secondaryNeed: "SI",
    triggers: { SI: 6, EI: 4, FI: 0, EnI: 9, SEI: 5 },
    description: "Eye relief and sensory relaxation for high screen users.",
    moods: ["Eye Relief", "Senses Relaxation", "Unplugging"],
    icon: <Activity className="w-6 h-6" />
  },
  {
    id: 7,
    name: "Urban Shield",
    primaryNeed: "EnI", 
    secondaryNeed: "EI",
    triggers: { SI: 5, EI: 5, FI: 0, EnI: 10, SEI: 2 },
    description: "Refreshing and cleansing against harsh environments.",
    moods: ["Refreshing", "Cleansing", "Protection"],
    icon: <Trees className="w-6 h-6" />
  },
  {
    id: 8,
    name: "Meditative Stillness",
    primaryNeed: "SI", 
    secondaryNeed: "SEI",
    triggers: { SI: 8, EI: 3, FI: 6, EnI: 0, SEI: 7 },
    description: "Deep calm for introspection and mindfulness.",
    moods: ["Deep Calm", "Introspection", "Mindfulness"],
    icon: <Wind className="w-6 h-6" />
  },
  {
    id: 9,
    name: "Fresh Optimism",
    primaryNeed: "EI", 
    secondaryNeed: "SEI",
    triggers: { SI: 4, EI: 8, FI: 0, EnI: 0, SEI: 7 },
    description: "Uplifts low mood and emotional flatness.",
    moods: ["Emotional Uplift", "Motivation", "Joy"],
    icon: <Zap className="w-6 h-6" />
  },
  {
    id: 10,
    name: "Warm Comfort",
    primaryNeed: "SEI", 
    secondaryNeed: "SI",
    triggers: { SI: 7, EI: 2, FI: 0, EnI: 0, SEI: 10 },
    description: "Safe, nurturing relaxation for emotional fatigue.",
    moods: ["Security", "Nurturing", "Relaxation"],
    icon: <Heart className="w-6 h-6" />
  },
  {
    id: 11,
    name: "Creative Spark",
    primaryNeed: "FI", 
    secondaryNeed: "EI",
    triggers: { SI: 2, EI: 7, FI: 10, EnI: 0, SEI: 6 },
    description: "Unlocks imagination and flows through creative blocks.",
    moods: ["Inspiration", "Imagination Flow", "Creativity"],
    icon: <Brain className="w-6 h-6" />
  },
  {
    id: 12,
    name: "Balanced Everyday",
    primaryNeed: "BAL",
    secondaryNeed: "BAL",
    triggers: { SI: 5, EI: 5, FI: 5, EnI: 5, SEI: 5 },
    description: "A neutral, stable fragrance for general lifestyle.",
    moods: ["Stability", "Neutral", "Daily Wear"],
    icon: <RefreshCw className="w-6 h-6" />
  }
];

// Helper to show full names of Indices
const INDEX_FULL_NAMES = {
  SI: "Stress Index",
  EI: "Energy Index",
  FI: "Focus Index",
  EnI: "Environment Index",
  SEI: "Sensitivity Index",
  BAL: "General Lifestyle Balance"
};

export default function FragranceSurvey() {
  const [step, setStep] = useState(0);
  const [scores, setScores] = useState({
    SI: 5, // Stress Index
    EI: 5, // Energy Index
    FI: 5, // Focus Index
    EnI: 5, // Environment Index
    SEI: 5 // Sensitivity Index
  });
  const [result, setResult] = useState(null);

  // Helper to update score
  const handleScoreChange = (indexKey, value) => {
    setScores(prev => ({ ...prev, [indexKey]: parseInt(value) }));
  };

  // --- THE ALGORITHM ---
  const calculateResult = () => {
    const entries = Object.entries(scores);
    entries.sort((a, b) => b[1] - a[1]);
    
    const dominantIndex = entries[0][0];

    const isBalanced = entries.every(([key, val]) => val >= 4 && val <= 6);
    if (isBalanced) {
      return FRAGRANCE_DB.find(f => f.name === "Balanced Everyday");
    }

    const scoredFragrances = FRAGRANCE_DB.map(frag => {
      let diffScore = 0;
      diffScore += Math.abs(scores.SI - frag.triggers.SI);
      diffScore += Math.abs(scores.EI - frag.triggers.EI);
      diffScore += Math.abs(scores.FI - frag.triggers.FI);
      diffScore += Math.abs(scores.EnI - frag.triggers.EnI);
      diffScore += Math.abs(scores.SEI - frag.triggers.SEI);
      return { ...frag, matchScore: diffScore };
    });

    scoredFragrances.sort((a, b) => a.matchScore - b.matchScore);
    return scoredFragrances[0];
  };

  const finishSurvey = () => {
    const recommended = calculateResult();
    setResult(recommended);
    setStep(6);
  };

  const resetSurvey = () => {
    setStep(0);
    setScores({ SI: 5, EI: 5, FI: 5, EnI: 5, SEI: 5 });
    setResult(null);
  };

  // --- UI COMPONENTS ---
  const QuestionCard = ({ title, description, indexKey, icon: Icon, nextStep, prevStep, isLast }) => (
    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full animate-fade-in mx-4">
      <div className="flex items-center gap-3 mb-4 text-purple-600">
        <Icon className="w-8 h-8" />
        <h2 className="text-xl font-bold uppercase tracking-wider">{indexKey} Assessment</h2>
      </div>
      
      <h3 className="text-2xl font-semibold text-gray-800 mb-2">{title}</h3>
      <p className="text-gray-500 mb-8">{description}</p>

      <div className="mb-8">
        <div className="flex justify-between text-sm font-medium text-gray-400 mb-2">
          <span>Low</span>
          <span>Moderate</span>
          <span>High</span>
        </div>
        <input 
          type="range" 
          min="0" 
          max="10" 
          value={scores[indexKey]} 
          onChange={(e) => handleScoreChange(indexKey, e.target.value)}
          className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600 hover:accent-purple-500 transition-all"
        />
        <div className="mt-4 text-center font-bold text-3xl text-purple-600">
          {scores[indexKey]}<span className="text-sm text-gray-400 font-normal">/10</span>
        </div>
      </div>

      <div className="flex justify-between pt-4 border-t border-gray-100">
        <button 
          onClick={prevStep} 
          disabled={step === 1}
          className={`px-6 py-2 rounded-lg font-medium transition-colors ${step === 1 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600 hover:bg-gray-100'}`}
        >
          Back
        </button>
        <button 
          onClick={isLast ? finishSurvey : nextStep} 
          className="bg-purple-600 hover:bg-purple-700 text-white px-8 py-2 rounded-lg font-medium flex items-center gap-2 transition-transform active:scale-95 shadow-lg shadow-purple-200"
        >
          {isLast ? "Find Match" : "Next"} <ArrowRight className="w-4 h-4" />
        </button>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-purple-50 font-sans text-slate-800 flex flex-col items-center justify-center p-4">
      
      {step === 0 && (
        <div className="text-center max-w-xl animate-fade-in-up">
          <div className="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
            <Sparkles className="w-8 h-8 text-purple-600" />
          </div>
          <h1 className="text-4xl md:text-5xl font-bold text-gray-900 mb-6 leading-tight">
            Discover Your <br/> <span className="text-purple-600">Soul Fragrance</span>
          </h1>
          <p className="text-lg text-gray-600 mb-8 leading-relaxed">
            Based on your Stress, Energy, Focus, Environment, and Emotional Sensitivity indices.
          </p>
          <button 
            onClick={() => setStep(1)}
            className="bg-purple-600 hover:bg-purple-700 text-white text-lg px-10 py-4 rounded-full font-semibold shadow-xl shadow-purple-200 transition-all hover:-translate-y-1 active:translate-y-0"
          >
            Start Assessment
          </button>
        </div>
      )}

      {step === 1 && (
        <QuestionCard 
          indexKey="SI"
          icon={Wind}
          title="Stress Index"
          description="How would you rate your current stress levels? Do you feel anxious, overwhelmed, or do you have trouble sleeping?"
          nextStep={() => setStep(2)}
          prevStep={() => setStep(0)}
        />
      )}

      {step === 2 && (
        <QuestionCard 
          indexKey="EI"
          icon={Zap}
          title="Energy Index"
          description="How is your vitality? Are you feeling energetic and ready to go, or fatigued and slow?"
          nextStep={() => setStep(3)}
          prevStep={() => setStep(1)}
        />
      )}

      {step === 3 && (
        <QuestionCard 
          indexKey="FI"
          icon={Brain}
          title="Focus Index"
          description="Do you need mental clarity right now? Are you working on complex tasks or feeling mentally scattered?"
          nextStep={() => setStep(4)}
          prevStep={() => setStep(2)}
        />
      )}

      {step === 4 && (
        <QuestionCard 
          indexKey="EnI"
          icon={Trees}
          title="Environment Index"
          description="Consider your surroundings. Are you exposed to pollution, harsh weather, or excessive screen time (digital smog)?"
          nextStep={() => setStep(5)}
          prevStep={() => setStep(3)}
        />
      )}

      {step === 5 && (
        <QuestionCard 
          indexKey="SEI"
          icon={Heart}
          title="Sensitivity Index"
          description="How emotionally sensitive or vulnerable do you feel? Do you need nurturing and emotional grounding?"
          isLast={true}
          nextStep={() => {}}
          prevStep={() => setStep(4)}
        />
      )}

      {/* Result Screen Updated to Match User Request */}
      {step === 6 && result && (
        <div className="max-w-3xl w-full animate-fade-in bg-white p-8 md:p-12 rounded-3xl shadow-2xl border-t-8 border-purple-600">
          
          <div className="flex flex-col md:flex-row items-start md:items-center gap-6 mb-8 border-b border-gray-100 pb-8">
            <div className="bg-purple-100 p-4 rounded-2xl text-purple-600">
              {result.icon}
            </div>
            <div>
              <h2 className="text-3xl font-bold text-gray-900">Recommended Match</h2>
              <p className="text-gray-500">Based on your unique index profile</p>
            </div>
          </div>

          <div className="space-y-6 text-lg font-medium text-gray-800">
            
            {/* ID Section */}
            <div className="flex flex-col sm:flex-row sm:items-baseline border-b border-gray-100 pb-4">
              <span className="text-purple-600 font-bold uppercase tracking-wider w-40 text-sm sm:text-base">
                ID:
              </span>
              <span className="text-2xl font-mono text-gray-900">
                #{result.id.toString().padStart(3, '0')}
              </span>
            </div>

            {/* Name Section */}
            <div className="flex flex-col sm:flex-row sm:items-baseline border-b border-gray-100 pb-4">
              <span className="text-purple-600 font-bold uppercase tracking-wider w-40 text-sm sm:text-base">
                Name:
              </span>
              <span className="text-2xl font-bold text-gray-900">
                {result.name}
              </span>
            </div>

            {/* Primary Need Section */}
            <div className="flex flex-col sm:flex-row sm:items-baseline border-b border-gray-100 pb-4">
              <span className="text-purple-600 font-bold uppercase tracking-wider w-40 text-sm sm:text-base">
                Primary Need:
              </span>
              <span className="text-xl text-gray-700">
                {INDEX_FULL_NAMES[result.primaryNeed] || result.primaryNeed}
              </span>
            </div>

            {/* Purpose Section */}
            <div className="flex flex-col sm:flex-row sm:items-start">
              <span className="text-purple-600 font-bold uppercase tracking-wider w-40 text-sm sm:text-base mt-1">
                Purpose:
              </span>
              <span className="text-xl text-gray-700 leading-relaxed">
                {result.description}
              </span>
            </div>

          </div>

          <div className="mt-10 pt-8 border-t border-gray-200 flex justify-center">
            <button 
              onClick={resetSurvey}
              className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-8 py-3 rounded-xl font-semibold transition-colors flex items-center gap-2"
            >
              <RefreshCw className="w-5 h-5" /> Start New Survey
            </button>
          </div>

        </div>
      )}

    </div>
  );
}
